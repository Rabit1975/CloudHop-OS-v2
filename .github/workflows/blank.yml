name: Auto-Merge Dry-Run → main (preview PRs only)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "30 3 * * *" # nightly (optional)
  push:
    branches:
      - '**'
    paths-ignore:
      - '.github/**'
      - 'docs/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  dry-run-merge:
    name: Dry-run merge branches into main (no writes to main)
    runs-on: ubuntu-latest
    env:
      TARGET_BRANCH: main
      REPO: ${{ github.repository }}
      TOKEN: ${{ secrets.GH_AUTOFIX_PAT || github.token }}

    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure git user
        run: |
          git config user.name "cloudhop-bot"
          git config user.email "cloudhop-bot@users.noreply.github.com"

      - name: Configure origin remote with token
        run: |
          echo "Configuring origin remote with token for authenticated git ops"
          git remote set-url origin https://x-access-token:${{ secrets.GH_AUTOFIX_PAT || github.token }}@github.com/${{ github.repository }}

      - name: Gather remote branches
        id: gather
        run: |
          set -euo pipefail
          git fetch origin --prune
          mapfile -t MAPFILE < <(git for-each-ref --format='%(refname:short)' refs/remotes/origin \
            | grep -vE '^origin/HEAD$|^origin/${TARGET_BRANCH}$' || true)
          if [ "${#MAPFILE[@]}" -eq 0 ]; then
            echo "branches=" >> $GITHUB_OUTPUT
          else
            {
              for b in "${MAPFILE[@]}"; do
                echo "${b#origin/}"
              done
            } | sed '/^$/d' > branches.txt
            echo "branches<<EOF" >> $GITHUB_OUTPUT
            cat branches.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Attempt merges and prepare preview branches / diffs
        id: attempt
        run: |
          set -euo pipefail
          TOKEN="${TOKEN}"
          REPO="${REPO}"
          TARGET="${TARGET_BRANCH}"
          RUN_ID="${{ github.run_id }}"
          mkdir -p .merge-results
          > .merge-results/previewed.txt
          > .merge-results/conflicted.txt

          mapfile -t BRANCHES < <(echo "${{ steps.gather.outputs.branches }}" | sed '/^$/d')

          if [ ${#BRANCHES[@]} -eq 0 ]; then
            echo "No remote branches to process."
            exit 0
          fi

          for br in "${BRANCHES[@]}"; do
            echo "=== Processing: ${br} ==="
            safe_name=$(echo "${br}" | sed 's#[^A-Za-z0-9._-]#-#g' | tr '[:upper:]' '[:lower:]')
            git fetch origin "${TARGET}"
            git checkout -B tmp-${TARGET} "origin/${TARGET}"
            git fetch origin "${br}:${br}-remote-temp" || true
            if git merge --no-ff --no-edit "origin/${br}"; then
              echo "Merge OK for ${br}."
              preview_branch="preview/merge-${safe_name}-${RUN_ID}"
              git branch -m "${preview_branch}"
              git push "https://x-access-token:${TOKEN}@github.com/${REPO}" "${preview_branch}:${preview_branch}" || {
                echo "Failed to push preview branch ${preview_branch}. Recording conflict fallback."
                echo "${br}" >> .merge-results/conflicted.txt
                git fetch origin "${TARGET}"
                git checkout -B tmp-${TARGET} "origin/${TARGET}"
                continue
              }
              echo "${preview_branch}" >> .merge-results/previewed.txt
              git fetch origin "${TARGET}"
              git checkout -B tmp-${TARGET} "origin/${TARGET}"
            else
              echo "Merge CONFLICT for ${br}."
              git merge --abort || true
              difffile=".merge-results/diff-${safe_name}.patch"
              git fetch origin "${br}"
              git diff origin/${TARGET}..origin/${br} > "${difffile}" || true
              echo "${br}|${difffile}" >> .merge-results/conflicted.txt
              git fetch origin "${TARGET}"
              git checkout -B tmp-${TARGET} "origin/${TARGET}"
            fi
          done

          echo "previewed_file=.merge-results/previewed.txt" >> $GITHUB_OUTPUT
          echo "conflicted_file=.merge-results/conflicted.txt" >> $GITHUB_OUTPUT

      - name: Create PRs for preview branches
        if: steps.attempt.outputs.previewed_file != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const previewsPath = path.join(process.cwd(), '.merge-results', 'previewed.txt');
            if (!fs.existsSync(previewsPath)) {
              core.info('No preview branches to create PRs for.');
              return;
            }
            const previews = fs.readFileSync(previewsPath, 'utf8').split(/\r?\n/).map(s => s.trim()).filter(Boolean);
            const { owner, repo } = context.repo;
            for (const previewBranch of previews) {
              const existing = await github.rest.pulls.list({
                owner,
                repo,
                state: 'open',
                head: `${owner}:${previewBranch}`,
                base: process.env.TARGET_BRANCH || 'main'
              });
              if (existing.data && existing.data.length > 0) {
                core.info(`Preview PR already exists for ${previewBranch}, skipping.`);
                continue;
              }
              const title = `Dry-run preview: merge ${previewBranch.replace(/^preview\\/merge-/, '')} → ${process.env.TARGET_BRANCH || 'main'}`;
              const body = [
                `This is a dry-run preview branch containing the result of merging \`${previewBranch}\` into \`${process.env.TARGET_BRANCH || 'main'}\`.`,
                '',
                'It was created automatically by the Auto-Merge Dry-Run workflow and does not modify `main`.',
                '',
                'Please review the merged result in this PR and merge manually if acceptable.'
              ].join('\n');
              await github.rest.pulls.create({
                owner,
                repo,
                title,
                head: previewBranch,
                base: process.env.TARGET_BRANCH || 'main',
                body
              });
              core.info(`Created preview PR from ${previewBranch} → ${process.env.TARGET_BRANCH || 'main'}`);
            }

      - name: Create PRs for conflict branches (include diff)
        if: steps.attempt.outputs.conflicted_file != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const conflictedPath = path.join(process.cwd(), '.merge-results', 'conflicted.txt');
            if (!fs.existsSync(conflictedPath)) {
              core.info('No conflicts recorded.');
              return;
            }
            const lines = fs.readFileSync(conflictedPath, 'utf8').split(/\r?\n/).filter(Boolean);
            const { owner, repo } = context.repo;

            for (const line of lines) {
              const parts = line.split('|');
              const br = parts[0].trim();
              const diffFile = parts[1] ? parts[1].trim() : null;

              const existing = await github.rest.pulls.list({
                owner,
                repo,
                state: 'open',
                head: `${owner}:${br}`,
                base: process.env.TARGET_BRANCH || 'main'
              });

              if (existing.data && existing.data.length > 0) {
                core.info(`Open PR already exists from ${br} → ${process.env.TARGET_BRANCH || 'main'}, skipping.`);
                continue;
              }

              let diffText = '';
              if (diffFile && fs.existsSync(diffFile)) {
                diffText = fs.readFileSync(diffFile, 'utf8').slice(0, 120000);
              }

              const title = `Dry-run conflict: ${br} → ${process.env.TARGET_BRANCH || 'main'}`;
              const bodyParts = [
                `Automatic dry-run merge of \`${br}\` into \`${process.env.TARGET_BRANCH || 'main'}\` encountered conflicts.`,
                '',
                'Please rebase or resolve conflicts in the branch and push, or use this PR thread to coordinate manual merging.',
                '',
              ];
              if (diffText) {
                bodyParts.push('---');
                bodyParts.push('Patch (main .. branch):');
                bodyParts.push('```diff');
                bodyParts.push(diffText);
                bodyParts.push('```');
              } else {
                bodyParts.push('_No patch available (diff generation failed or empty)._');
              }

              const body = bodyParts.join('\n');

              await github.rest.pulls.create({
                owner,
                repo,
                title,
                head: br,
                base: process.env.TARGET_BRANCH || 'main',
                body
              });

              core.info(`Created conflict PR for ${br} → ${process.env.TARGET_BRANCH || 'main'}`);
            }

      - name: Summary
        run: |
          echo "Dry-run merge job completed."
          echo "Preview branches pushed (if any) and PRs created for previews and conflicts."
          echo "Check the Actions logs and the created PRs for details."
